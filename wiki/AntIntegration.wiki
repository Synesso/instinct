#summary Integrating Instinct with Ant
#labels Tutorial
<wiki:toc max_depth="3"/>

<[UsersGuide User's Guide]>

Instinct comes with two Ant tasks. The first of these `<instinct>` executes your specifications. The second `<instinct-report>` generates an HTML report on the specification results.

= Integrating with Ant =

  # Download Instinct.
  # Ensure you have the Ant 1.7.0 Jar in your classpath. 
  # Add the Instinct jar and required libraries to your classpath
  # Within your build file, define the Instinct tasks so that Ant can see them.
  # Create a target for Instinct that runs after your main code and specification code is compiled. Within this target, run the `instinct` task, pointing it at the directory containing the (compiled) specification classes.
  # Create a target for Instinct Report that runs after the Instinct task. Within this target, run the `instinct-report` task, pointing it at a fileset of XML report files (an output of the Instinct task).

The following sections take you through these steps in detail. The [http://code.google.com/p/instinct/downloads/list example project] contains a working example of this build.

== Add Required Libraries to the Classpath ==

Before the Ant tasks can be run, you will need to define a classpath so that Instinct can find your classes and the classes it needs to run. The classes that will go into this classpath will include any classes your specifications will access (such as the production code under scrutiny, libraries used, etc.) as well as libraries required by Instinct. Details for what libraries are required when can be found in the [http://instinct.googlecode.com/svn/trunk/core/README project readme].

The following example is the minimal set required for running from Ant.

{{{
<path id="spec.class.path">
    <path refid="main.class.path"/>
    <fileset dir="${basedir}">
        <include name="${lib.dir}/cglib-nodep-*.jar"/>
        <include name="${lib.dir}/jmock-*.jar"/>
        <include name="${lib.dir}/objenesis-*.jar"/>
        <include name="${lib.dir}/ant-1.*.jar"/>
        <include name="${lib.dir}/hamcrest-all-*.jar"/>
        <include name="${lib.dir}/functionaljava-*.jar"/>
        <include name="${lib.dir}/junit-*.jar"/>
        <include name="${lib.dir}/commons-collections-*.jar"/><!-- as of instinct v0.20.0 -->
        <include name="${lib.dir}/commons-lang-*.jar"/><!-- as of instinct v0.20.0 -->
        <include name="${lib.dir}/velocity-*.jar"/><!-- as of instinct v0.20.0 -->
    </fileset>
    <pathelement location="${spec.classes.dir}"/>
</path>
}}}

== Using the Instinct Ant Tasks ==

In order to use the Instinct tasks, you first need to make them available to Ant, using the [http://ant.apache.org/manual/CoreTasks/taskdef.html taskdef] element.

{{{
<taskdef name="instinct" classname="com.googlecode.instinct.integrate.ant.InstinctAntTask" classpathref="spec.class.path"/>
}}}

You could also use the resource form of the taskdef element:

{{{
<taskdef resource="instincttask.properties" classpathref="spec.class.path"/>
}}}

===The Instinct Task===
After defining the task, use the `instinct` task to run your specifications:

{{{
<instinct failureproperty="specs-failed">
    <classpath refid="spec.class.path"/>
    <specifications dir="${spec.classes.dir}" groups="osdc"/>
    <formatter type="brief"/>
    <formatter type="xml" toDir="${spec.output.dir}"/>
</instinct>
}}}

The elements used in the `instinct` task are as follows:

  * Element {{{instinct}}} - The Instinct Ant task.
    * Attribute {{{failureproperty}}} - The name of the property to set if any specifications fail. You need to combine this with a {{{<fail/>}}} element if you want the build to fail when a test fails (see the complete example below for details).
  * Element {{{specifications}}} - This element tells Instinct how to find the specifications to run. Specifications are currently found based on annotations. You can have as many `specifications` as you like, Instinct will search them all for specifications to run. This is useful if you keep your specifications in different source trees.
    * Attribute {{{dir}}} - The directory containing the (compiled) specification classes. This is the root directory of the package containing the specifications.
  * Element {{{formatter}}} - Tells Instinct how to format the results of the specifications it runs. Since v0.20.0 you can specify multiple formatters for each `instinct` task.
    * Attribute {{{type}}} - The type of output format to use. Supported output formats are "brief", "quiet", "verbose" and "xml".
      * The {{{brief}}} formatter displays the results of behaviour context on on a single line, with a summary of all the contained specifications. 
      * The {{{quiet}}} formatter prints failures and a summary only. 
      * The {{{verbose}}} formatter displays a summary of each context on one line (similar to the brief formatter), followed by details of each of the contained specifications. Failures include the full stack trace of the failure, making output quite verbose. 
      * The {{{xml}}} formatter (available in v0.20.0 onwards) displays the result in an XML format compatible with XML output of the JUnit task.
    * Attribute {{{toDir}}} - If set to a writable directory, this optional attribute will direct the formatter's output to a file in that directory instead of to the console.

Example of brief output:

{{{
-run-specs:
 [instinct] AGlossyMagazine
 [instinct] - mustSaveTheTitleGivenInConstructor
 [instinct] ANonEmptyStack
 [instinct] - isNoLongerFullAfterPoppingAllElements
 [instinct] - mustNoLongerBeFullAfterPop
 [instinct] AnEmptyMagazineRack
 [instinct] - callsPushOnStackWhenAddAMagazineIsAddedToThePile
 [instinct] AnEmptyShoppingCart
 [instinct] - doesNotFailWhenAnItemIsRemovedFromIt
 [instinct] - shouldBeEmpty
 [instinct] - canHaveMultipleItemsAddedToIt
 [instinct] - canHaveAnItemAddedToIt
 [instinct] AnEmptyStack
 [instinct] - willReturnTheSameObjectWhenPushed
 [instinct] - mustNoLongerBeEmptyAfterPush
 [instinct] - mustBeEmpty
 [instinct] StateExpectationsExample
 [instinct] - providesMatchersForMakingAssertionsAboutEvents
 [instinct] - providesMatchersForMakingAssertionsAboutDoubles
 [instinct] - providesMatchersForMakingAssertionsAboutMaps
 [instinct] - providesMatchersForMakingAssertionsAboutArrays
 [instinct] - providesMatchersForMakingAssertionsAboutClasses
 [instinct] - providesMatchersForMakingAssertionsAboutCollectionsAndIterables
 [instinct] - providesMatchersForMakingAssertionsAboutComparables
 [instinct] - providesMatchersForMakingAssertionsAboutObjects
 [instinct] - providesMatchersForMakingAssertionsAboutStrings
}}}

Example of verbose output:

{{{
-run-specs:
 [instinct] AGlossyMagazine, Specifications run: 1, Successes: 1, Failures: 0, Total time elapsed: 0.016 seconds
 [instinct]     mustSaveTheTitleGivenInConstructor, Time elapsed: 0.016 seconds, Status: succeeded
 [instinct] ANonEmptyStack, Specifications run: 2, Successes: 2, Failures: 0, Total time elapsed: 0.0020 seconds
 [instinct]     isNoLongerFullAfterPoppingAllElements, Time elapsed: 0.0020 seconds, Status: succeeded
 [instinct]     mustNoLongerBeFullAfterPop, Time elapsed: 0.0 seconds, Status: succeeded
 [instinct] AnEmptyMagazineRack, Specifications run: 1, Successes: 1, Failures: 0, Total time elapsed: 0.262 seconds
 [instinct]     callsPushOnStackWhenAddAMagazineIsAddedToThePile, Time elapsed: 0.262 seconds, Status: succeeded
 [instinct] AnEmptyShoppingCart, Specifications run: 4, Successes: 4, Failures: 0, Total time elapsed: 0.039 seconds
 [instinct]     doesNotFailWhenAnItemIsRemovedFromIt, Time elapsed: 0.017 seconds, Status: succeeded
 [instinct]     shouldBeEmpty, Time elapsed: 0.0080 seconds, Status: succeeded
 [instinct]     canHaveMultipleItemsAddedToIt, Time elapsed: 0.0080 seconds, Status: succeeded
 [instinct]     canHaveAnItemAddedToIt, Time elapsed: 0.0060 seconds, Status: succeeded
 [instinct] AnEmptyStack, Specifications run: 3, Successes: 3, Failures: 0, Total time elapsed: 0.0010 seconds
 [instinct]     willReturnTheSameObjectWhenPushed, Time elapsed: 0.0010 seconds, Status: succeeded
 [instinct]     mustNoLongerBeEmptyAfterPush, Time elapsed: 0.0 seconds, Status: succeeded
 [instinct]     mustBeEmpty, Time elapsed: 0.0 seconds, Status: succeeded
 [instinct] StateExpectationsExample, Specifications run: 9, Successes: 9, Failures: 0, Total time elapsed: 0.029 seconds
 [instinct]     providesMatchersForMakingAssertionsAboutEvents, Time elapsed: 0.0030 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutDoubles, Time elapsed: 0.0020 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutMaps, Time elapsed: 0.0040 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutArrays, Time elapsed: 0.0040 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutClasses, Time elapsed: 0.0020 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutCollectionsAndIterables, Time elapsed: 0.0040 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutComparables, Time elapsed: 0.0010 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutObjects, Time elapsed: 0.0050 seconds, Status: succeeded
 [instinct]     providesMatchersForMakingAssertionsAboutStrings, Time elapsed: 0.0040 seconds, Status: succeeded
}}}

=== The Instinct Report Task ===
After executing the instinct task with XML file output, use the `instinct-report` task on those XML files to generate an HTML report of your specification results:

{{{
<instinct-report file="${spec.reports.dir}/report.html">
    <fileset dir="${spec.output.dir}">
        <include name="SPEC-*.xml"/>
    </fileset>
</instinct-report>
}}}

The elements used in the `instinct-report` task are as follows:

  * Element {{{instinct-report}}} - The Instinct Report Ant task.
    * Attribute {{{file}}} - The report file to be generated.
  * Element {{{fileset}}} - a [http://ant.apache.org/manual/CoreTypes/fileset.html fileset] identifying the XML output files generated by the `instinct` task.

Example of a specification result:

http://instinct.googlecode.com/svn/wiki/images/report.passed.png

Example of a specification result with a failed specification:

http://instinct.googlecode.com/svn/wiki/images/report.failed.png


== Complete Example ==

Here is an example of a build file (build.xml) taken from the example project.

{{{
<?xml version="1.0" encoding="UTF-8"?>
<project name="instinct-example" default="run-specs" basedir=".">

    <property name="build.dir" value="build"/>
    <property name="lib.dir" value="lib"/>
    <property name="src.dir" value="src"/>
    <property name="main.dir" value="${src.dir}/main"/>
    <property name="spec.dir" value="${src.dir}/spec"/>
    <property name="main.src.dir" value="${main.dir}/java"/>
    <property name="spec.src.dir" value="${spec.dir}/java"/>
    <property name="spec.resources.dir" value="${spec.dir}/resources"/>
    <property name="main.classes.dir" value="${build.dir}/main-classes"/>
    <property name="spec.classes.dir" value="${build.dir}/spec-classes"/>
    <property name="spec.reports.dir" value="${basedir}/build/reports"/>

    <property name="instinct.jar" value="${lib.dir}/instinct-0.1.9.jar"/>

    <path id="main.class.path">
        <fileset dir="${basedir}">
            <include name="${instinct.jar}"/>
        </fileset>
        <pathelement location="${main.classes.dir}"/>
    </path>
    <path id="spec.class.path">
        <path refid="main.class.path"/>
        <fileset dir="${basedir}">
            <include name="${lib.dir}/cglib-nodep-*.jar"/>
            <include name="${lib.dir}/jmock-*.jar"/>
            <include name="${lib.dir}/objenesis-*.jar"/>
            <include name="${lib.dir}/ant-1.*.jar"/>
            <include name="${lib.dir}/hamcrest-all-*.jar"/>
            <include name="${lib.dir}/junit-*.jar"/>
            <include name="${lib.dir}/functionaljava-*.jar"/>
            <include name="${lib.dir}/commons-collections-*.jar"/>
            <include name="${lib.dir}/commons-lang-*.jar"/>
            <include name="${lib.dir}/velocity-*.jar"/>
        </fileset>
        <pathelement location="${spec.classes.dir}"/>
        <pathelement location="${spec.resources.dir}"/>
    </path>

    <target name="clean" depends="-clean"/>
    <target name="run-specs" depends="clean,-run-specs,-run-junit3-integration,-run-junit4-integration"/>

    <target name="-clean">
        <delete dir="${build.dir}"/>
    </target>

    <target name="-generate">
        <copy todir="${spec.classes.dir}">
            <fileset dir="${spec.resources.dir}" includes="**/*"/>
        </copy>
    </target>

    <macrodef name="compile.macro">
        <attribute name="src.dir"/>
        <attribute name="output.dir"/>
        <attribute name="classpath.ref"/>
        <attribute name="src.path"/>
        <sequential>
            <mkdir dir="@{output.dir}"/>
            <javac source="1.5" srcdir="@{src.dir}" destdir="@{output.dir}" classpathref="@{classpath.ref}" debug="true"
                    debuglevel="source,lines,vars" deprecation="false" optimize="true">
                <src>
                    <path path="@{src.path}"/>
                </src>



                <patternset includes="**/*.java"/>
                <compilerarg value="-Xlint"/>
            </javac>
        </sequential>
    </macrodef>

    <target name="-compile" depends="-generate">
        <compile.macro src.dir="${main.src.dir}" classpath.ref="main.class.path" output.dir="${main.classes.dir}"
                src.path="${main.src.dir}"/>
        <compile.macro src.dir="${spec.src.dir}" classpath.ref="spec.class.path" output.dir="${spec.classes.dir}"
                src.path="${spec.src.dir}"/>
    </target>

    <target name="-run-specs" depends="-compile">
        <taskdef resource="instincttask.properties" classpathref="spec.class.path"/>
        <mkdir dir="${spec.reports.dir}"/>
        <instinct failureproperty="specs-failed">
            <classpath refid="scala.spec.class.path"/>
            <specifications dir="${spec.classes.dir}" groups="osdc"/>
            <formatter type="brief"/>
            <formatter type="xml" toDir="${spec.reports.dir}"/><!-- as of instinct v0.20.0 -->
        </instinct>
        <fail if="specs-failed" message="Specifications failed."/>
    </target>

    <target name="-run-junit3-integration" depends="-compile">
        <junit failureproperty="tests-failed" fork="true" forkmode="perBatch">
            <classpath refid="spec.class.path"/>
            <test name="com.googlecode.instinct.example.junit.StackJUnitSuite"/>
            <formatter type="brief" usefile="false"/>
        </junit>
        <fail if="tests-failed" message="JUnit 3 integration suite(s) failed."/>
    </target>

    <target name="-run-junit4-integration" depends="-compile">
        <junit failureproperty="tests-failed" fork="true" forkmode="perBatch">
            <classpath refid="spec.class.path"/>
            <test name="com.googlecode.instinct.example.junit.StackJUnit4Suite"/>
            <test name="com.googlecode.instinct.example.csvreader.junit.CsvReaderJUnitTests"/>
            <formatter type="brief" usefile="false"/>
        </junit>
        <fail if="tests-failed" message="JUnit 4 integration suite(s) failed."/>
    </target>

</project>
}}}

<[UsersGuide User's Guide]>